{% extends 'base.html' %}
{% load static %}
{% block css %}
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.5.0/main.min.css">
    {# 弹窗插件 layer #}
    <link rel="stylesheet" href="{% static 'plugins/layer/theme/default/layer.css' %}"/>
{% endblock %}
{% block main %}
    {% include 'navbar.html' with activeTag="agenda" %}
    <section class="content">
        <div class="box box-primary">
            <div class="box-body no-padding">
                <!-- THE CALENDAR -->
                <h3>个人日程</h3>
                <div id="personal_calendar">
                </div>
            </div>
            <!-- /.box-body -->
        </div>
    </section>
{% endblock %}
{% block js %}
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.5.0/main.min.js"></script>
    <!-- the moment-to-fullcalendar connector. must go AFTER the moment lib -->
    {# 标题格式化需要用到moment #}
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/moment@5.5.0/main.global.min.js'></script>
    {# 弹窗插件 layer #}
    <script src="{% static 'plugins/layer/layer.js' %}"></script>
    <script type="text/javascript">
        {#    fullcalendar初始化和汉化设置    #}
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('personal_calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'zh-cn',
                customButtons: {
                    {# 添加按钮逻辑 #}
                    add: {
                        text: '添加',
                        click: function () {
                            layer.open({
                                type: 2,
                                title: '新建日程',
                                shadeClose: false,
                                maxmin: true,
                                area: ['800px', '460px'],
                                content: "{% url 'agenda:create' %}",
                                end: function () {
                                    window.location.reload();
                                }
                            });
                        }
                    }
                },
                headerToolbar: {
                    left: 'prev,next,today,add',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                buttonText: {
                    today: '今天',
                    month: '月',
                    week: '周',
                    day: '日',
                },
                {#设置标题格式#}
                views: {
                    dayGridMonth: {
                        titleFormat: 'YYYY年M月',
                    },
                    timeGridWeek: {titleFormat: 'YYYY年M月D日'},
                    timeGridDay: {titleFormat: 'YYYY年M月D日'},
                },
                allDayText: "全天",
                {# 显示个人日程 #}
                events: [
                    {% for agenda in personal_agenda %}
                        {
                            id: {{ agenda.id }},
                            title: '{{ agenda.title }}',
                            start: '{{ agenda.start_time | date:"Y-m-d H:i"}}',
                            end: '{{ agenda.end_time | date:"Y-m-d H:i"}}',
                            {% if agenda.priority_level == 5  %}
                                backgroundColor: '#0073b7',
                            {% elif agenda.priority_level == 3 %}
                                backgroundColor: '#00a65a',
                            {% else %}
                                backgroundColor: '#dd4b39',
                            {% endif %}

                        },
                    {% endfor %}
                ],
                {# 点击事件 #}
                eventClick: function (info) {
                    {# django 模板无法直接传入js变量，这里进行字符串替换 #}
                    var eventID = info.event.id;
                    var url = "{% url 'agenda:detail' 12345 %}".replace('12345', eventID)
                    layer.open({
                        type: 2,
                        title: '日程详情',
                        shadeClose: false,
                        maxmin: true,
                        area: ['800px', '460px'],
                        content: url,
                        end: function () {
                            window.location.reload();
                        }
                    });
                }

            });
            calendar.render();
        });
    </script>
{% endblock %}